# 手动上传功能实现文档

## 📋 概述

已成功为 bili-up-web 添加了手动干预定时任务的功能，用户现在可以：
- 查看任务队列统计
- 手动触发视频上传
- 手动触发字幕上传
- 实时监控各个阶段的任务状态

## 🎯 实现的功能

### 1. 后端 API 接口

#### 新增路由
- `POST /api/v1/videos/:id/upload/video` - 手动触发视频上传
- `POST /api/v1/videos/:id/upload/subtitle` - 手动触发字幕上传

#### 修改的文件
- `bili-up-api/internal/handler/video_handler.go`
  - 添加 `manualUploadVideo()` 方法
  - 添加 `manualUploadSubtitle()` 方法
  - 添加 `SetUploadScheduler()` 方法连接上传调度器
  
- `bili-up-api/internal/chain_task/upload_scheduler.go`
  - 添加 `ExecuteManualUpload()` 方法支持手动触发

- `bili-up-api/main.go`
  - 修改依赖注入，将 `UploadScheduler` 注入到 `VideoHandler`
  - 更新 `registerHandlers()` 函数签名

#### API 行为
- **视频上传**：
  - 只允许状态为 `200`(准备就绪) 或 `299`(上传失败) 的视频
  - 更新状态为 `201`(上传中)
  - 异步执行上传任务
  - 成功后更新为 `300`，失败后更新为 `299`

- **字幕上传**：
  - 只允许状态为 `300`(视频已上传) 或 `399`(字幕上传失败) 的视频
  - 要求视频已有 BVID
  - 更新状态为 `301`(上传字幕中)
  - 异步执行上传任务
  - 成功后更新为 `400`，失败后更新为 `399`

### 2. 前端组件

#### 新增组件

##### `TaskQueueStats.tsx`
位置：`src/components/dashboard/TaskQueueStats.tsx`

功能：
- 显示各个状态的视频数量统计
- 实时刷新（每30秒自动刷新）
- 显示总视频数和进行中任务数
- 8个状态指示器：待处理、处理中、准备就绪、上传视频中、视频已上传、上传字幕中、全部完成、失败

##### `VideoActions.tsx`
位置：`src/components/video/VideoActions.tsx`

功能：
- 根据视频状态显示可用的操作按钮
- 状态 `200` 或 `299`：显示"立即上传视频"按钮
- 状态 `300` 或 `399`：显示"立即上传字幕"按钮
- 显示操作结果（成功/失败提示）
- 包含警告提示，说明手动上传会打断定时队列

#### 修改的组件

##### `StatusBadge.tsx`
- 新增状态码支持：
  - `200` - 准备就绪（绿色）
  - `201` - 上传视频中（紫色，动画）
  - `299` - 上传失败（红色）
  - `300` - 视频已上传（青色）
  - `301` - 上传字幕中（靛蓝色，动画）
  - `399` - 字幕上传失败（橙色）
  - `400` - 全部完成（翠绿色）

##### `VideoDetailPage.tsx`
- 在右侧栏顶部集成 `VideoActions` 组件
- 上传成功后自动刷新页面数据

##### `page.tsx` (主页)
- 添加"任务队列"导航项
- 集成 `TaskQueueStats` 组件
- 默认显示任务队列统计页面

##### `globals.css`
- 为新状态码添加对应的 CSS 样式类

## 🎨 状态流转图

```
001 (待处理)
  ↓ 自动 (准备阶段)
002 (处理中)
  ↓ 自动
200 (准备就绪) ←─────────┐
  ↓ 定时/手动            │ 手动重试
201 (上传视频中)          │
  ↓ 成功 ──────┐         │
  ↓ 失败       │         │
299 (上传失败) ─────────┘
  
300 (视频已上传) ←────────┐
  ↓ 定时/手动             │ 手动重试
301 (上传字幕中)           │
  ↓ 成功 ──────┐          │
  ↓ 失败       │          │
399 (字幕上传失败) ────────┘
  
400 (全部完成) ✓
```

## 🚀 使用方法

### 查看任务队列统计
1. 登录后，默认显示"任务队列"页面
2. 可以看到各个阶段的视频数量
3. 每30秒自动刷新，也可手动点击"刷新"按钮

### 手动上传视频
1. 进入视频详情页面
2. 如果视频状态为 `200`(准备就绪) 或 `299`(上传失败)
3. 在右侧会显示"立即上传视频"按钮
4. 点击按钮，确认后开始上传
5. 上传任务在后台执行，可以刷新页面查看进度

### 手动上传字幕
1. 进入视频详情页面
2. 如果视频状态为 `300`(视频已上传) 或 `399`(字幕上传失败)
3. 在右侧会显示"立即上传字幕"按钮
4. 点击按钮，确认后开始上传
5. 上传任务在后台执行，可以刷新页面查看进度

## ⚠️ 注意事项

1. **手动上传优先级**：手动上传会立即执行，但不会影响定时任务的调度逻辑
2. **状态限制**：只有特定状态的视频才能执行对应的手动操作
3. **异步执行**：上传任务在后台异步执行，页面返回成功只表示任务已启动
4. **字幕上传前提**：必须先成功上传视频（有BVID）才能上传字幕
5. **建议使用场景**：
   - 紧急需要上传某个视频
   - 某个视频上传失败需要立即重试
   - 不想等待定时任务的自动调度

## 🔧 技术细节

### 状态码定义
参考 `bili-up-api/docs/任务状态码说明.md`

### 定时上传策略
- 视频上传：每小时自动上传一个准备好的视频
- 字幕上传：视频上传成功1小时后自动上传字幕
- 检查频率：每5分钟检查一次

### API 响应格式
```json
{
  "code": 200,
  "message": "视频上传任务已启动",
  "data": {
    "video_id": "xxx",
    "status": "201",
    "message": "视频正在后台上传中，请稍后刷新查看结果"
  }
}
```

## 📊 统计数据刷新机制
- 自动刷新：每30秒
- 手动刷新：点击刷新按钮
- 数据源：通过 `/api/v1/videos` 接口获取所有视频并统计

## 🎯 下一步优化建议

1. **实时通知**：使用 WebSocket 或 SSE 实现实时状态更新
2. **批量操作**：支持批量手动上传多个视频
3. **优先级队列**：为手动上传的视频设置更高的优先级
4. **操作历史**：记录所有手动操作的日志
5. **权限控制**：为手动上传添加权限验证
6. **预估时间**：显示预计完成时间
7. **进度条**：显示上传的实时进度

## ✅ 测试清单

- [x] 后端 API 编译通过
- [x] 前端组件创建完成
- [x] 状态码样式已添加
- [x] 页面布局已调整
- [x] 所有新功能已集成到主页面
- [ ] 实际测试手动上传视频功能
- [ ] 实际测试手动上传字幕功能
- [ ] 验证状态流转正确性
- [ ] 验证统计数据准确性

## 📝 相关文档

- [任务链拆分实现总结](../bili-up-api/docs/任务链拆分实现总结.md)
- [任务链拆分快速参考](../bili-up-api/docs/任务链拆分快速参考.md)
- [任务状态码说明](../bili-up-api/docs/任务状态码说明.md)

---

**更新时间**: 2025-10-16
**版本**: v1.0.0
